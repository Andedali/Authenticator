name: Build APK

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            git \
            zip \
            unzip \
            openjdk-17-jdk \
            autoconf \
            libtool \
            libltdl-dev \
            pkg-config \
            zlib1g-dev \
            libncurses5-dev \
            libncursesw5-dev \
            libtinfo5 \
            cmake \
            libffi-dev \
            libssl-dev \
            automake \
            lld \
            ccache

      - name: Install Buildozer and dependencies
        run: |
          pip install --upgrade pip
          pip install "Cython==0.29.36" buildozer

      - name: Cache Buildozer global directory
        uses: actions/cache@v4
        with:
          path: ~/.buildozer
          key: buildozer-${{ runner.os }}-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            buildozer-${{ runner.os }}-

      - name: Set JAVA_HOME to Java 17
        run: |
          export JAVA_HOME=$JAVA_HOME_17_X64
          echo "JAVA_HOME=$JAVA_HOME_17_X64" >> $GITHUB_ENV

      - name: Build APK with Buildozer
        run: |
          buildozer -v android debug

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: authenticator-apk
          path: bin/*.apk
          if-no-files-found: error

  test:
    needs: build
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: authenticator-apk
          path: apk/

      - name: Enable KVM for emulator
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4444.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Set up JDK 17
        run: echo "JAVA_HOME=$JAVA_HOME_17_X64" >> $GITHUB_ENV

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Create test script
        run: |
          cat > test_apk.sh << 'SCRIPT'
          #!/bin/bash
          set -e
          echo "=== Emulator booted ==="

          APK_FILE=$(find apk/ -name "*.apk" | head -1)
          echo "Installing APK: $APK_FILE"

          if [ -z "$APK_FILE" ]; then
            echo "ERROR: No APK found!"
            ls -la apk/
            exit 1
          fi

          adb install "$APK_FILE"

          adb logcat -c
          adb logcat -v time > logcat_full.txt &
          LOGCAT_PID=$!

          echo "=== Launching app ==="
          adb shell am start -n org.andedali.authenticator/org.kivy.android.PythonActivity

          echo "=== Waiting 60s for app to start ==="
          sleep 60

          echo "=== Checking app status ==="
          adb shell pidof org.andedali.authenticator || echo "APP CRASHED - process not found"

          adb shell screencap -p /sdcard/screenshot.png
          adb pull /sdcard/screenshot.png screenshot.png || echo "Failed to pull screenshot"

          kill $LOGCAT_PID 2>/dev/null || true
          sleep 2

          grep -iE "(python|kivy|authenticator|exception|error|traceback|crash)" logcat_full.txt > logcat_python.txt || true
          echo "=== Python logs ==="
          cat logcat_python.txt
          echo "=== Done ==="
          SCRIPT
          chmod +x test_apk.sh

      - name: Run emulator and capture logcat
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          arch: x86_64
          profile: pixel_5
          emulator-options: -no-window -gpu swiftshader_indirect -no-snapshot -noaudio -no-boot-anim
          disable-animations: true
          script: bash test_apk.sh

      - name: Upload logcat logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: emulator-logs
          path: |
            logcat_full.txt
            logcat_python.txt
            screenshot.png
          if-no-files-found: warn
